<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ„RTCæµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .warning {
            color: #ffc107;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007AFF;
            padding-left: 10px;
        }
        .log-item.success {
            border-left-color: #28a745;
        }
        .log-item.error {
            border-left-color: #dc3545;
        }
        .log-item.warning {
            border-left-color: #ffc107;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 300px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å³æ„RTCé›†æˆæµ‹è¯•å·¥å…·</h1>

    <!-- æµ‹è¯•1: APIç«¯ç‚¹æµ‹è¯• -->
    <div class="test-section">
        <h2>1. APIç«¯ç‚¹æµ‹è¯•</h2>
        <button onclick="testZegoAuthAPI()">æµ‹è¯•å³æ„é‰´æƒAPI</button>
        <button onclick="testByteDanceAuthAPI()">æµ‹è¯•å­—èŠ‚è·³åŠ¨é‰´æƒAPI</button>
        <div id="api-result"></div>
    </div>

    <!-- æµ‹è¯•2: SDKåŠ è½½æµ‹è¯• -->
    <div class="test-section">
        <h2>2. SDKåŠ è½½æµ‹è¯•</h2>
        <button onclick="testSDKLoad()">æ£€æŸ¥å³æ„SDK</button>
        <button onclick="testProtobufLoad()">æ£€æŸ¥Protobufåº“</button>
        <div id="sdk-result"></div>
    </div>

    <!-- æµ‹è¯•3: å³æ„RTCè¿æ¥æµ‹è¯• -->
    <div class="test-section">
        <h2>3. å³æ„RTCè¿æ¥æµ‹è¯•</h2>
        <input type="text" id="roomId" placeholder="æˆ¿é—´IDï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰" />
        <button onclick="testZegoConnection()">æµ‹è¯•è¿æ¥</button>
        <button onclick="testZegoDisconnect()">æ–­å¼€è¿æ¥</button>
        <div id="zego-result"></div>
    </div>

    <!-- æµ‹è¯•4: éŸ³é¢‘æµæµ‹è¯• -->
    <div class="test-section">
        <h2>4. éŸ³é¢‘æµæµ‹è¯•</h2>
        <button onclick="testAudioStream()">æµ‹è¯•éŸ³é¢‘æµå‘å¸ƒ</button>
        <button onclick="testStopAudio()">åœæ­¢éŸ³é¢‘æµ</button>
        <div id="audio-result"></div>
    </div>

    <!-- æµ‹è¯•5: è‡ªå®šä¹‰æ¶ˆæ¯æµ‹è¯• -->
    <div class="test-section">
        <h2>5. è‡ªå®šä¹‰æ¶ˆæ¯æµ‹è¯•ï¼ˆç¿»è¯‘å¹¿æ’­ï¼‰</h2>
        <input type="text" id="testMessage" placeholder="æµ‹è¯•æ¶ˆæ¯å†…å®¹" value="Hello, è¿™æ˜¯æµ‹è¯•æ¶ˆæ¯" />
        <button onclick="testCustomMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
        <div id="message-result"></div>
    </div>

    <!-- æ—¥å¿—åŒºåŸŸ -->
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logs" class="log"></div>
    </div>

    <!-- åŠ è½½å³æ„SDK -->
    <script src="https://lib.zego.im/express/zego-express-engine-webrtc-3.0.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>

    <script>
        let zegoEngine = null;
        let zegoStreamId = null;
        let zegoRoomId = null;
        let zegoConfig = null;
        let mediaStream = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            const time = new Date().toLocaleTimeString();
            item.textContent = `[${time}] ${message}`;
            logsDiv.appendChild(item);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // æµ‹è¯•1: å³æ„é‰´æƒAPI
        async function testZegoAuthAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';
            log('å¼€å§‹æµ‹è¯•å³æ„é‰´æƒAPI...', 'info');

            try {
                const response = await fetch('/api/zego-auth');
                const data = await response.json();

                if (response.ok && data.appId && data.appSign) {
                    zegoConfig = data;
                    resultDiv.innerHTML = `
                        <p class="success">âœ… APIæµ‹è¯•æˆåŠŸ</p>
                        <p><strong>AppID:</strong> ${data.appId}</p>
                        <p><strong>AppSign:</strong> ${data.appSign.substring(0, 20)}...</p>
                        <p><strong>ServerSecret:</strong> ${data.serverSecret ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
                    `;
                    log('å³æ„é‰´æƒAPIæµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ APIæµ‹è¯•å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    log(`å³æ„é‰´æƒAPIæµ‹è¯•å¤±è´¥: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
                log(`å³æ„é‰´æƒAPIè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å­—èŠ‚è·³åŠ¨é‰´æƒAPI
        async function testByteDanceAuthAPI() {
            log('å¼€å§‹æµ‹è¯•å­—èŠ‚è·³åŠ¨é‰´æƒAPI...', 'info');
            try {
                const response = await fetch('/api/auth');
                const data = await response.json();
                if (response.ok) {
                    log('å­—èŠ‚è·³åŠ¨é‰´æƒAPIæµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    log(`å­—èŠ‚è·³åŠ¨é‰´æƒAPIæµ‹è¯•å¤±è´¥: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`å­—èŠ‚è·³åŠ¨é‰´æƒAPIè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•2: SDKåŠ è½½
        function testSDKLoad() {
            const resultDiv = document.getElementById('sdk-result');
            const sdkLoaded = typeof ZegoExpressEngine !== 'undefined';
            
            if (sdkLoaded) {
                resultDiv.innerHTML = '<p class="success">âœ… å³æ„SDKå·²åŠ è½½</p>';
                log('å³æ„SDKæ£€æŸ¥æˆåŠŸ', 'success');
            } else {
                resultDiv.innerHTML = '<p class="error">âŒ å³æ„SDKæœªåŠ è½½</p>';
                log('å³æ„SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥CDNé“¾æ¥', 'error');
            }
        }

        function testProtobufLoad() {
            const pbLoaded = typeof protobuf !== 'undefined';
            if (pbLoaded) {
                log('Protobufåº“æ£€æŸ¥æˆåŠŸ', 'success');
            } else {
                log('Protobufåº“æœªåŠ è½½', 'error');
            }
        }

        // æµ‹è¯•3: å³æ„RTCè¿æ¥
        async function testZegoConnection() {
            const resultDiv = document.getElementById('zego-result');
            resultDiv.innerHTML = '<p>è¿æ¥ä¸­...</p>';

            // å…ˆè·å–é…ç½®
            if (!zegoConfig) {
                log('å…ˆè·å–å³æ„é…ç½®...', 'info');
                await testZegoAuthAPI();
            }

            if (!zegoConfig || !zegoConfig.appId || !zegoConfig.appSign) {
                resultDiv.innerHTML = '<p class="error">âŒ å³æ„é…ç½®æœªè·å–ï¼Œè¯·å…ˆæµ‹è¯•API</p>';
                return;
            }

            if (typeof ZegoExpressEngine === 'undefined') {
                resultDiv.innerHTML = '<p class="error">âŒ å³æ„SDKæœªåŠ è½½</p>';
                return;
            }

            try {
                zegoEngine = new ZegoExpressEngine(zegoConfig.appId, zegoConfig.appSign);
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬
                zegoEngine.on('roomUserUpdate', (roomID, updateType, userList) => {
                    log(`æˆ¿é—´ç”¨æˆ·æ›´æ–°: ${roomID}, ${updateType}, ç”¨æˆ·æ•°: ${userList.length}`, 'info');
                });

                zegoEngine.on('roomStreamUpdate', (roomID, updateType, streamList) => {
                    log(`æˆ¿é—´æµæ›´æ–°: ${roomID}, ${updateType}, æµæ•°: ${streamList.length}`, 'info');
                });

                zegoEngine.on('receiveCustomCommand', (fromUser, command) => {
                    log(`æ”¶åˆ°è‡ªå®šä¹‰æ¶ˆæ¯: æ¥è‡ª ${fromUser.userID}, å†…å®¹: ${JSON.stringify(command)}`, 'success');
                });

                // ç™»å½•æˆ¿é—´
                zegoRoomId = document.getElementById('roomId').value || `test_room_${Date.now()}`;
                const userId = `test_user_${Date.now()}`;
                zegoStreamId = `stream_${userId}`;

                log(`å°è¯•ç™»å½•æˆ¿é—´: ${zegoRoomId}, ç”¨æˆ·ID: ${userId}`, 'info');
                const loginResult = await zegoEngine.loginRoom(
                    zegoRoomId,
                    null,
                    {
                        userID: userId,
                        userName: 'æµ‹è¯•ç”¨æˆ·'
                    },
                    {
                        userUpdate: true
                    }
                );

                if (loginResult === 0) {
                    resultDiv.innerHTML = `
                        <p class="success">âœ… å³æ„RTCè¿æ¥æˆåŠŸ</p>
                        <p><strong>æˆ¿é—´ID:</strong> ${zegoRoomId}</p>
                        <p><strong>æµID:</strong> ${zegoStreamId}</p>
                    `;
                    log('å³æ„RTCè¿æ¥æˆåŠŸ', 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ ç™»å½•å¤±è´¥ï¼Œé”™è¯¯ç : ${loginResult}</p>`;
                    log(`å³æ„RTCç™»å½•å¤±è´¥ï¼Œé”™è¯¯ç : ${loginResult}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</p>`;
                log(`å³æ„RTCè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testZegoDisconnect() {
            if (zegoEngine && zegoRoomId) {
                zegoEngine.logoutRoom(zegoRoomId);
                zegoEngine = null;
                zegoRoomId = null;
                zegoStreamId = null;
                log('å·²æ–­å¼€å³æ„RTCè¿æ¥', 'info');
                document.getElementById('zego-result').innerHTML = '<p>å·²æ–­å¼€è¿æ¥</p>';
            }
        }

        // æµ‹è¯•4: éŸ³é¢‘æµ
        async function testAudioStream() {
            const resultDiv = document.getElementById('audio-result');
            
            if (!zegoEngine || !zegoStreamId) {
                resultDiv.innerHTML = '<p class="error">âŒ è¯·å…ˆè¿æ¥å³æ„RTC</p>';
                return;
            }

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                await zegoEngine.startPublishingStream(zegoStreamId, mediaStream);
                resultDiv.innerHTML = '<p class="success">âœ… éŸ³é¢‘æµå‘å¸ƒæˆåŠŸ</p>';
                log('éŸ³é¢‘æµå‘å¸ƒæˆåŠŸ', 'success');
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ éŸ³é¢‘æµå‘å¸ƒå¤±è´¥: ${error.message}</p>`;
                log(`éŸ³é¢‘æµå‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testStopAudio() {
            if (zegoEngine && zegoStreamId) {
                zegoEngine.stopPublishingStream(zegoStreamId);
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                log('éŸ³é¢‘æµå·²åœæ­¢', 'info');
                document.getElementById('audio-result').innerHTML = '<p>éŸ³é¢‘æµå·²åœæ­¢</p>';
            }
        }

        // æµ‹è¯•5: è‡ªå®šä¹‰æ¶ˆæ¯
        async function testCustomMessage() {
            const resultDiv = document.getElementById('message-result');
            const message = document.getElementById('testMessage').value;

            if (!zegoEngine || !zegoRoomId) {
                resultDiv.innerHTML = '<p class="error">âŒ è¯·å…ˆè¿æ¥å³æ„RTC</p>';
                return;
            }

            try {
                const command = {
                    type: 'translation',
                    subtitle: {
                        text: message,
                        eventType: 654
                    },
                    timestamp: Date.now()
                };

                zegoEngine.sendCustomCommand(zegoRoomId, JSON.stringify(command), (result) => {
                    if (result.errorCode === 0) {
                        resultDiv.innerHTML = '<p class="success">âœ… è‡ªå®šä¹‰æ¶ˆæ¯å‘é€æˆåŠŸ</p>';
                        log('è‡ªå®šä¹‰æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                    } else {
                        resultDiv.innerHTML = `<p class="error">âŒ å‘é€å¤±è´¥ï¼Œé”™è¯¯ç : ${result.errorCode}</p>`;
                        log(`è‡ªå®šä¹‰æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œé”™è¯¯ç : ${result.errorCode}`, 'error');
                    }
                });
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ å‘é€å¤±è´¥: ${error.message}</p>`;
                log(`è‡ªå®šä¹‰æ¶ˆæ¯å‘é€å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥SDK
        window.addEventListener('load', () => {
            log('æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            testSDKLoad();
            testProtobufLoad();
        });
    </script>
</body>
</html>

