# 即构RTC集成使用说明

## 概述

项目已集成即构RTC服务，实现P2P音频流传输（低延迟），同时保留字节跳动API的翻译功能。

## 架构说明

### 新架构（即构RTC）
```
用户A ──即构RTC(P2P)──> 用户B (音频流，低延迟)
  ↓
字节跳动API (翻译)
  ↓
翻译结果 → 即构自定义消息 → 用户B
```

## 环境变量配置

在Vercel控制台配置以下环境变量：

1. **ZEGO_APP_ID**：即构应用ID
2. **ZEGO_APP_SIGN**：即构AppSign（用于前端）
3. **ZEGO_SERVER_SECRET**：即构ServerSecret（可选，用于服务端Token生成）

## 功能说明

### 1. 音频流传输
- **P2P音频流**：通过即构RTC实现用户间的直接音频传输（低延迟，20-100ms）
- **翻译音频**：通过字节跳动API获取，通过即构自定义消息广播

### 2. 房间管理
- 使用即构的房间功能管理用户加入/离开
- 自动订阅房间内其他用户的音频流
- 自动处理流的添加/删除

### 3. 翻译结果广播
- 当收到字节跳动的翻译结果后，自动通过即构自定义消息广播给房间内其他用户
- 支持字幕和音频两种类型的翻译结果

## 降级机制

如果即构RTC初始化失败，系统会自动降级到纯WebSocket模式：
- 音频通过代理服务器转发（原有方式）
- 翻译结果通过代理服务器广播

## 使用流程

1. **用户A开始录音**
   - 系统自动初始化即构RTC
   - 登录房间
   - 发布音频流
   - 连接字节跳动API进行翻译

2. **用户B加入房间**
   - 自动订阅用户A的音频流（P2P）
   - 接收用户A的翻译结果（通过自定义消息）

3. **翻译结果处理**
   - 用户A说话 → 字节跳动API翻译
   - 翻译结果 → 通过即构自定义消息广播给用户B
   - 用户B看到翻译字幕 + 听到翻译语音

## 注意事项

1. **即构配置安全**：AppSign会暴露给前端，这是即构SDK的正常使用方式
2. **兼容性**：即构SDK会自动处理WebRTC兼容性和NAT穿透
3. **成本**：即构有免费额度，超出后按使用量计费
4. **测试**：需要在不同网络环境下测试P2P连接成功率

## 故障排查

### 即构RTC未连接
- 检查环境变量是否配置正确
- 检查浏览器控制台是否有错误信息
- 确认即构SDK是否成功加载（检查 `typeof ZegoExpressEngine`）

### 音频流未播放
- 检查浏览器是否允许自动播放音频
- 检查即构房间流更新事件是否正常触发
- 检查网络连接是否正常

### 翻译结果未广播
- 检查即构房间是否成功登录
- 检查自定义消息发送是否成功（查看控制台日志）
- 确认房间内是否有其他用户

## API端点

### `/api/zego-auth`
获取即构RTC配置信息（从环境变量读取）

**响应示例：**
```json
{
  "appId": "your_app_id",
  "appSign": "your_app_sign",
  "serverSecret": "your_server_secret"
}
```

