# 即构RTC完整测试方案

## 测试前准备

1. ✅ 确认Vercel环境变量已配置：
   - `ZEGO_APP_ID`
   - `ZEGO_APP_SIGN`
   - `ZEGO_SERVER_SECRET`（可选）

2. ✅ 确认项目已重新部署

3. ✅ 准备两个浏览器窗口（或两台设备）用于测试双人房间

## 测试步骤

### 阶段1：API端点测试

#### 1.1 测试即构鉴权API
打开浏览器控制台，执行：
```javascript
fetch('/api/zego-auth')
  .then(r => r.json())
  .then(data => console.log('即构配置:', data))
  .catch(err => console.error('错误:', err));
```

**预期结果：**
```json
{
  "appId": "2072475215",
  "appSign": "...",
  "serverSecret": "..." 或 null
}
```

**如果失败：**
- 检查环境变量是否配置正确
- 检查Vercel部署是否成功
- 查看浏览器Network标签页的响应

---

### 阶段2：SDK加载测试

#### 2.1 检查即构SDK是否加载
打开浏览器控制台，执行：
```javascript
console.log('即构SDK:', typeof ZegoExpressEngine);
```

**预期结果：**
```
即构SDK: function
```

**如果失败：**
- 检查 `index.html` 中的SDK CDN链接是否正确
- 检查网络连接是否正常
- 尝试刷新页面

---

### 阶段3：单用户功能测试

#### 3.1 测试录音和即构RTC初始化
1. 打开应用页面
2. 点击"开始"按钮
3. 允许麦克风权限
4. 观察浏览器控制台日志

**预期日志：**
```
✅ 即构RTC登录成功，房间ID: room_xxx
✅ 即构RTC音频流发布成功
✅ 会话已开始
```

**检查点：**
- [ ] 即构RTC是否成功初始化
- [ ] 是否成功登录房间
- [ ] 是否成功发布音频流
- [ ] 字节跳动API是否连接成功
- [ ] 状态显示是否正常

#### 3.2 测试说话和翻译
1. 对着麦克风说话（中文或英文）
2. 观察字幕显示
3. 观察控制台日志

**预期结果：**
- 在"我的翻译"区域显示翻译字幕
- 控制台显示：`🌐 我的译文: xxx`
- 如果模式是"s2s"，会收到TTS音频数据

**检查点：**
- [ ] 字幕是否正确显示
- [ ] 翻译结果是否正确
- [ ] 控制台是否有错误

---

### 阶段4：双用户房间测试（核心功能）

#### 4.1 准备两个浏览器窗口
- **窗口A**：Chrome（用户A）
- **窗口B**：Chrome无痕模式 或 Firefox（用户B）

#### 4.2 用户A加入房间
1. 在窗口A中打开应用
2. 点击"开始"按钮
3. 记录房间ID（从页面显示或控制台日志）

**预期日志（窗口A）：**
```
✅ 即构RTC登录成功，房间ID: room_xxx
✅ 即构RTC音频流发布成功
```

#### 4.3 用户B加入同一房间
1. 在窗口B中打开应用
2. **重要**：在控制台执行以下代码设置相同的房间ID：
```javascript
// 先获取用户A的房间ID（从窗口A的控制台或页面显示）
// 假设房间ID是 room_1234567890
currentRoomId = 'room_1234567890';
console.log('设置房间ID:', currentRoomId);
```
3. 点击"开始"按钮

**预期日志（窗口B）：**
```
✅ 即构RTC登录成功，房间ID: room_xxx
即构房间用户更新: room_xxx ADD [{userID: "userA", ...}]
✅ 已订阅并播放即构音频流: stream_userA_xxx
```

**预期日志（窗口A）：**
```
即构房间用户更新: room_xxx ADD [{userID: "userB", ...}]
```

**检查点：**
- [ ] 用户B是否看到用户A加入的提示
- [ ] 用户A是否看到用户B加入的提示
- [ ] 用户B是否自动订阅了用户A的音频流

#### 4.4 测试P2P音频传输
1. **用户A说话**（对着麦克风）
2. **用户B应该能听到**用户A的原始语音（通过即构RTC P2P传输）

**检查点：**
- [ ] 用户B是否能听到用户A的语音（低延迟，20-100ms）
- [ ] 音频质量是否清晰
- [ ] 是否有明显延迟

#### 4.5 测试翻译结果广播
1. **用户A说话**（例如："你好"）
2. 等待翻译结果返回
3. 观察两个窗口

**预期结果（用户A窗口）：**
- "我的翻译"区域显示：`Hello`（或对应翻译）
- 控制台显示：`🌐 我的译文: Hello`
- 控制台显示：`✅ 翻译结果已通过即构RTC广播`

**预期结果（用户B窗口）：**
- "对方的翻译"区域显示：`Hello`
- 控制台显示：`📨 收到即构自定义消息`
- 控制台显示：`🌐 对方译文: Hello`
- 如果模式是"s2s"，用户B应该听到翻译语音

**检查点：**
- [ ] 用户A的翻译字幕是否正确显示在用户B的"对方的翻译"区域
- [ ] 用户B是否听到翻译语音（s2s模式）
- [ ] 控制台是否有广播成功的日志

#### 4.6 测试反向翻译（用户B说话）
1. **用户B说话**（例如："Hello"）
2. 观察两个窗口

**预期结果：**
- 用户B看到自己的翻译字幕
- 用户A看到用户B的翻译字幕
- 用户A听到用户B的翻译语音（s2s模式）

**检查点：**
- [ ] 双向翻译是否都正常工作
- [ ] 是否避免了回音（自己不播放自己的翻译语音）

---

### 阶段5：错误处理和降级测试

#### 5.1 测试即构RTC失败时的降级
1. 临时修改环境变量（例如删除ZEGO_APP_SIGN）
2. 重新部署
3. 测试功能是否仍能工作（应降级到纯WebSocket模式）

**预期结果：**
- 控制台显示：`⚠️ 即构配置获取失败，将仅使用WebSocket模式`
- 功能仍能正常工作（通过代理服务器）
- 翻译结果仍能广播（通过代理服务器）

---

## 测试检查清单

### 基础功能
- [ ] 即构鉴权API正常返回配置
- [ ] 即构SDK成功加载
- [ ] 即构RTC成功初始化
- [ ] 房间登录成功
- [ ] 音频流发布成功

### 单用户功能
- [ ] 录音功能正常
- [ ] 翻译功能正常
- [ ] 字幕显示正常
- [ ] 音频播放正常（s2s模式）

### 双用户功能（核心）
- [ ] 用户加入房间提示正常
- [ ] P2P音频流传输正常（低延迟）
- [ ] 翻译结果正确广播
- [ ] 对方字幕正确显示
- [ ] 对方语音正确播放（s2s模式）
- [ ] 双向翻译都正常工作
- [ ] 避免回音（自己不播放自己的翻译）

### 错误处理
- [ ] 即构RTC失败时能降级到WebSocket模式
- [ ] 错误信息显示清晰
- [ ] 网络断开时能正确处理

---

## 常见问题排查

### 问题1：即构RTC未初始化
**检查：**
- 环境变量是否配置正确
- `/api/zego-auth` 是否返回正确数据
- 浏览器控制台是否有错误

**解决：**
```javascript
// 在控制台检查
fetch('/api/zego-auth').then(r => r.json()).then(console.log);
```

### 问题2：房间内看不到其他用户
**检查：**
- 两个用户是否使用相同的房间ID
- 即构房间事件是否正常触发
- 控制台是否有相关日志

**解决：**
```javascript
// 确认房间ID
console.log('当前房间ID:', currentRoomId);
```

### 问题3：听不到对方的原始语音
**检查：**
- P2P连接是否成功建立
- 浏览器是否允许自动播放音频
- 即构流订阅是否成功

**解决：**
- 检查浏览器音频权限设置
- 查看控制台是否有流订阅成功的日志

### 问题4：翻译结果未广播
**检查：**
- 即构自定义消息是否发送成功
- 对方是否在房间内
- 控制台是否有相关错误

**解决：**
```javascript
// 检查即构引擎状态
console.log('即构引擎:', zegoEngine);
console.log('房间ID:', zegoRoomId);
```

---

## 性能指标

### 预期延迟
- **P2P音频流**：20-100ms（即构RTC）
- **翻译结果**：200-600ms（字节跳动API）
- **翻译广播**：<50ms（即构自定义消息）

### 预期质量
- **音频清晰度**：清晰，无明显噪音
- **流畅度**：无卡顿，无断断续续
- **稳定性**：长时间使用无断开

---

## 测试报告模板

```
测试日期：____
测试人员：____
Vercel部署URL：____

测试结果：
- API端点测试：✅/❌
- SDK加载测试：✅/❌
- 单用户功能：✅/❌
- 双用户P2P音频：✅/❌
- 翻译结果广播：✅/❌
- 错误处理：✅/❌

发现的问题：
1. ____
2. ____

性能指标：
- P2P音频延迟：____ms
- 翻译延迟：____ms
- 音频质量：____
```

